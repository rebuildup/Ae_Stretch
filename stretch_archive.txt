Date:20250106 19:42
Code:Skeleton.h
#pragma once

#ifndef SKELETON_H
#define SKELETON_H

typedef unsigned char		u_char;
typedef unsigned short		u_short;
typedef unsigned short		u_int16;
typedef unsigned long		u_long;
typedef short int			int16;
#define PF_TABLE_BITS	12
#define PF_TABLE_SZ_16	4096

#define PF_DEEP_COLOR_AWARE 1	// make sure we get 16bpc pixels; 
// AE_Effect.h checks for this.

#include "AEConfig.h"

#ifdef AE_OS_WIN
typedef unsigned short PixelType;
#include <Windows.h>
#endif

#include "entry.h"
#include "AE_Effect.h"
#include "AE_EffectCB.h"
#include "AE_Macros.h"
#include "Param_Utils.h"
#include "AE_EffectCBSuites.h"
#include "String_Utils.h"
#include "AE_GeneralPlug.h"
#include "AEFX_ChannelDepthTpl.h"
#include "AEGP_SuiteHandler.h"

#include "Skeleton_Strings.h"

#include "AEFX_SuiteHelper.h"

/* Versioning information */

#define	MAJOR_VERSION	1
#define	MINOR_VERSION	1
#define	BUG_VERSION		0
#define	STAGE_VERSION	PF_Stage_DEVELOP
#define	BUILD_VERSION	1

/* Parameter defaults */

// 入力レイヤーのみ
enum {
	SKELETON_INPUT = 0,
	SKELETON_NUM_PARAMS // パラメーター数は1つ（入力レイヤーのみ）
};
extern "C" {

	DllExport
		PF_Err
		EffectMain(
			PF_Cmd			cmd,
			PF_InData* in_data,
			PF_OutData* out_data,
			PF_ParamDef* params[],
			PF_LayerDef* output,
			void* extra);

}

#endif // SKELETON_H

Code:SkeletonPiPL.r
#include "AEConfig.h"
#include "AE_EffectVers.h"

#ifndef AE_OS_WIN
	#include <AE_General.r>
#endif
	
resource 'PiPL' (16000) {
	{	
		Kind {
			AEEffect
		},
		
		Name {
			"stretch"
		},
		
		Category {
			"Stretch"
		},
#ifdef AE_OS_WIN
	#ifdef AE_PROC_INTELx64
		CodeWin64X86 {"EffectMain"},
	#endif
#else
	#ifdef AE_OS_MAC
		CodeMacIntel64 {"EffectMain"},
		CodeMacARM64 {"EffectMain"},
	#endif
#endif
		
		AE_PiPL_Version {
			2,
			0
		},
		
		AE_Effect_Spec_Version {
			PF_PLUG_IN_VERSION,
			PF_PLUG_IN_SUBVERS
		},
		
		AE_Effect_Version {
			557057	/* 1.1 */
		},
		
		AE_Effect_Info_Flags {
			0
		},
		
		AE_Effect_Global_OutFlags {
			0x02000000 //50332160
		},
		
		AE_Effect_Global_OutFlags_2 {
			0x08000000 // PF_OutFlag2_SUPPORTS_THREADED_RENDERING
		},
		
		AE_Effect_Match_Name {
			"Stretch"
		},
		
		AE_Reserved_Info {
			0
		},
		
		AE_Effect_Support_URL {
			"https://www.adobe.com"
		}
	}
};


Code:Skeleton_Strings.cpp
#include "Skeleton.h"

typedef struct {
	A_u_long	index;
	A_char		str[256];
} TableString;

// 文字列テーブル
TableString		g_strs[StrID_NUMTYPES] = {
	StrID_NONE,						"",
	StrID_Name,						"stretch",
	StrID_Description,				"そんなの関係ある(ｷﾘｯ)"
};

char* GetStringPtr(int strNum)
{
	return g_strs[strNum].str;
}


Code:Skeleton.cpp
#include "Skeleton.h"

static PF_Err
About(
	PF_InData* in_data,
	PF_OutData* out_data,
	PF_ParamDef* params[],
	PF_LayerDef* output)
{
	AEGP_SuiteHandler suites(in_data->pica_basicP);

	suites.ANSICallbacksSuite1()->sprintf(out_data->return_msg,
		"%s v%d.%d\r%s",
		STR(StrID_Name),
		MAJOR_VERSION,
		MINOR_VERSION,
		STR(StrID_Description));
	return PF_Err_NONE;
}

static PF_Err
GlobalSetup(
	PF_InData* in_data,
	PF_OutData* out_data,
	PF_ParamDef* params[],
	PF_LayerDef* output)
{
	out_data->my_version = PF_VERSION(MAJOR_VERSION,
		MINOR_VERSION,
		BUG_VERSION,
		STAGE_VERSION,
		BUILD_VERSION);

	out_data->out_flags = PF_OutFlag_DEEP_COLOR_AWARE;	// just 16bpc, not 32bpc
	out_data->out_flags2 |= PF_OutFlag2_SUPPORTS_THREADED_RENDERING; // MFR対応フラグを追加

	return PF_Err_NONE;
}

static PF_Err
FrameSetup(
	PF_InData* in_data,
	PF_OutData* out_data,
	PF_ParamDef* params[],
	PF_LayerDef* output)
{
	// MFR用の初期化や準備をここに記述
	return PF_Err_NONE;
}


static PF_Err ParamsSetup(
	PF_InData* in_data,
	PF_OutData* out_data,
	PF_ParamDef* params[],
	PF_LayerDef* output)
{
	out_data->num_params = SKELETON_NUM_PARAMS; // パラメーター数を設定

	return PF_Err_NONE;
}


#include <mutex>
std::mutex renderMutex;

static PF_Err Render(
	PF_InData* in_data,
	PF_OutData* out_data,
	PF_ParamDef* params[],
	PF_LayerDef* output)
{
	PF_Err err = PF_Err_NONE;

	PF_LayerDef* input = &params[SKELETON_INPUT]->u.ld; // 入力レイヤーを正しく取得
	if (!input || !input->data || !output || !output->data) {
		return PF_Err_BAD_CALLBACK_PARAM;
	}

	PF_Pixel* src = (PF_Pixel*)input->data;
	PF_Pixel* dst = (PF_Pixel*)output->data;

	int width = input->width;
	int height = input->height;
	int srcRowBytes = input->rowbytes / sizeof(PF_Pixel);
	int dstRowBytes = output->rowbytes / sizeof(PF_Pixel);

	A_long shift = 50; // 固定シフト量

	for (int y = 0; y < height; y++) {
		for (int x = 0; x < width; x++) {
			int shiftedX = x - shift; // 左方向にシフト

			if (shiftedX >= 0 && shiftedX < width) {
				dst[y * dstRowBytes + x] = src[y * srcRowBytes + shiftedX];
			}
			else {
				dst[y * dstRowBytes + x].alpha = 0;
				dst[y * dstRowBytes + x].red = 0;
				dst[y * dstRowBytes + x].green = 0;
				dst[y * dstRowBytes + x].blue = 0;
			}
		}
	}

	return err;
}


extern "C" DllExport
PF_Err PluginDataEntryFunction2(
	PF_PluginDataPtr inPtr,
	PF_PluginDataCB2 inPluginDataCallBackPtr,
	SPBasicSuite* inSPBasicSuitePtr,
	const char* inHostName,
	const char* inHostVersion)
{
	PF_Err result = PF_Err_INVALID_CALLBACK;

	result = PF_REGISTER_EFFECT_EXT2(
		inPtr,
		inPluginDataCallBackPtr,
		"stretch", // Name
		"Stretch", // Match Name
		"Stretch", // Category
		AE_RESERVED_INFO, // Reserved Info
		"EffectMain",	// Entry point
		"https://www.adobe.com");	// support URL

	return result;
}


PF_Err
EffectMain(
	PF_Cmd			cmd,
	PF_InData* in_data,
	PF_OutData* out_data,
	PF_ParamDef* params[],
	PF_LayerDef* output,
	void* extra)
{
	PF_Err		err = PF_Err_NONE;

	try {
		switch (cmd) {
		case PF_Cmd_ABOUT:
			err = About(in_data, out_data, params, output);
			break;
		case PF_Cmd_GLOBAL_SETUP:
			err = GlobalSetup(in_data, out_data, params, output);
			break;
		case PF_Cmd_PARAMS_SETUP:
			err = ParamsSetup(in_data, out_data, params, output);
			break;
		case PF_Cmd_RENDER:
			err = Render(in_data, out_data, params, output);
			break;
		}
	}
	catch (PF_Err& thrown_err) {
		err = thrown_err;
	}
	return err;
}



Date:20250106 21:21
Code:Skeleton.h
#pragma once

#ifndef SKELETON_H
#define SKELETON_H

typedef unsigned char		u_char;
typedef unsigned short		u_short;
typedef unsigned short		u_int16;
typedef unsigned long		u_long;
typedef short int			int16;
#define PF_TABLE_BITS	12
#define PF_TABLE_SZ_16	4096

#define PF_DEEP_COLOR_AWARE 1	// make sure we get 16bpc pixels; 
// AE_Effect.h checks for this.

#include "AEConfig.h"

#ifdef AE_OS_WIN
typedef unsigned short PixelType;
#include <Windows.h>
#endif

#include "entry.h"
#include "AE_Effect.h"
#include "AE_EffectCB.h"
#include "AE_Macros.h"
#include "Param_Utils.h"
#include "AE_EffectCBSuites.h"
#include "String_Utils.h"
#include "AE_GeneralPlug.h"
#include "AEFX_ChannelDepthTpl.h"
#include "AEGP_SuiteHandler.h"

#include "Skeleton_Strings.h"

#include "AEFX_SuiteHelper.h"

/* Versioning information */

#define	MAJOR_VERSION	1
#define	MINOR_VERSION	1
#define	BUG_VERSION		0
#define	STAGE_VERSION	PF_Stage_DEVELOP
#define	BUILD_VERSION	1

/* Parameter defaults */

// 入力レイヤーのみ
enum {
	SKELETON_INPUT = 0,
	SKELETON_NUM_PARAMS = 2,
	//PF_Param_FLOAT_SLIDER
};
enum {
	INTENSITY_DISK_ID = 1
};
extern "C" {

	DllExport
		PF_Err
		EffectMain(
			PF_Cmd			cmd,
			PF_InData* in_data,
			PF_OutData* out_data,
			PF_ParamDef* params[],
			PF_LayerDef* output,
			void* extra);

}

#endif // SKELETON_H

Code:SkeletonPiPL.r
#pragma once

#ifndef SKELETON_H
#define SKELETON_H

typedef unsigned char		u_char;
typedef unsigned short		u_short;
typedef unsigned short		u_int16;
typedef unsigned long		u_long;
typedef short int			int16;
#define PF_TABLE_BITS	12
#define PF_TABLE_SZ_16	4096

#define PF_DEEP_COLOR_AWARE 1	// make sure we get 16bpc pixels; 
// AE_Effect.h checks for this.

#include "AEConfig.h"

#ifdef AE_OS_WIN
typedef unsigned short PixelType;
#include <Windows.h>
#endif

#include "entry.h"
#include "AE_Effect.h"
#include "AE_EffectCB.h"
#include "AE_Macros.h"
#include "Param_Utils.h"
#include "AE_EffectCBSuites.h"
#include "String_Utils.h"
#include "AE_GeneralPlug.h"
#include "AEFX_ChannelDepthTpl.h"
#include "AEGP_SuiteHandler.h"

#include "Skeleton_Strings.h"

#include "AEFX_SuiteHelper.h"

/* Versioning information */

#define	MAJOR_VERSION	1
#define	MINOR_VERSION	1
#define	BUG_VERSION		0
#define	STAGE_VERSION	PF_Stage_DEVELOP
#define	BUILD_VERSION	1

/* Parameter defaults */

// 入力レイヤーのみ
enum {
	SKELETON_INPUT = 0,
	SKELETON_NUM_PARAMS = 2,
	//PF_Param_FLOAT_SLIDER
};
enum {
	INTENSITY_DISK_ID = 1
};
extern "C" {

	DllExport
		PF_Err
		EffectMain(
			PF_Cmd			cmd,
			PF_InData* in_data,
			PF_OutData* out_data,
			PF_ParamDef* params[],
			PF_LayerDef* output,
			void* extra);

}

#endif // SKELETON_H

Code:Skeleton_Strings.cpp
#include "Skeleton.h"

typedef struct {
	A_u_long	index;
	A_char		str[256];
} TableString;

// 文字列テーブル
TableString		g_strs[StrID_NUMTYPES] = {
	StrID_NONE,						"",
	StrID_Name,						"stretch",
	StrID_Description,				"そんなの関係ある(ｷﾘｯ)"
};

char* GetStringPtr(int strNum)
{
	return g_strs[strNum].str;
}

Code:Skeleton.cpp
#include "Skeleton.h"

static PF_Err
About(
	PF_InData* in_data,
	PF_OutData* out_data,
	PF_ParamDef* params[],
	PF_LayerDef* output)
{
	AEGP_SuiteHandler suites(in_data->pica_basicP);

	suites.ANSICallbacksSuite1()->sprintf(out_data->return_msg,
		"%s v%d.%d\r%s",
		STR(StrID_Name),
		MAJOR_VERSION,
		MINOR_VERSION,
		STR(StrID_Description));
	return PF_Err_NONE;
}

static PF_Err
GlobalSetup(
	PF_InData* in_data,
	PF_OutData* out_data,
	PF_ParamDef* params[],
	PF_LayerDef* output)
{
	out_data->my_version = PF_VERSION(MAJOR_VERSION,
		MINOR_VERSION,
		BUG_VERSION,
		STAGE_VERSION,
		BUILD_VERSION);

	out_data->out_flags = PF_OutFlag_DEEP_COLOR_AWARE;	// just 16bpc, not 32bpc
	out_data->out_flags2 |= PF_OutFlag2_SUPPORTS_THREADED_RENDERING; // MFR対応フラグを追加

	return PF_Err_NONE;
}

static PF_Err
FrameSetup(
	PF_InData* in_data,
	PF_OutData* out_data,
	PF_ParamDef* params[],
	PF_LayerDef* output)
{
	// MFR用の初期化や準備をここに記述
	return PF_Err_NONE;
}


static PF_Err ParamsSetup(
	PF_InData* in_data,
	PF_OutData* out_data,
	PF_ParamDef* params[],
	PF_LayerDef* output)
{
	PF_Err err = PF_Err_NONE;
	PF_ParamDef def;

	AEFX_CLR_STRUCT(def);
	PF_ADD_FLOAT_SLIDERX(
		"スライダー名",     // パラメータ名
		0,                  // 最小値
		100 << 16,          // 最大値 (固定小数点形式)
		0,                  // 最小値 (UI表示用)
		100,                // 最大値 (UI表示用)
		50 << 16,           // デフォルト値 (固定小数点形式)
		PF_Precision_INTEGER,
		0,
		0,
		INTENSITY_DISK_ID
	);

	out_data->num_params = INTENSITY_DISK_ID + 1;

	return err;
}


#include <mutex>
std::mutex renderMutex;

static PF_Err Render(
	PF_InData* in_data,
	PF_OutData* out_data,
	PF_ParamDef* params[],
	PF_LayerDef* output)
{
	PF_Err err = PF_Err_NONE;

	PF_LayerDef* input = &params[SKELETON_INPUT]->u.ld; // 入力レイヤーを正しく取得

	PF_Fixed slider_value = params[INTENSITY_DISK_ID]->u.fd.value;
	PF_FpLong float_value = FIX_2_FLOAT(slider_value);

	if (!input || !input->data || !output || !output->data) {
		return PF_Err_BAD_CALLBACK_PARAM;
	}

	PF_Pixel* src = (PF_Pixel*)input->data;
	PF_Pixel* dst = (PF_Pixel*)output->data;

	int width = input->width;
	int height = input->height;
	int srcRowBytes = input->rowbytes / sizeof(PF_Pixel);
	int dstRowBytes = output->rowbytes / sizeof(PF_Pixel);

	A_long shift = (A_long)float_value;

	for (int y = 0; y < height; y++) {
		for (int x = 0; x < width; x++) {
			int shiftedX = x - shift; // 左方向にシフト

			if (shiftedX >= 0 && shiftedX < width) {
				dst[y * dstRowBytes + x] = src[y * srcRowBytes + shiftedX];
			}
			else {
				dst[y * dstRowBytes + x].alpha = 0;
				dst[y * dstRowBytes + x].red = 0;
				dst[y * dstRowBytes + x].green = 0;
				dst[y * dstRowBytes + x].blue = 0;
			}
		}
	}

	return err;
}


extern "C" DllExport
PF_Err PluginDataEntryFunction2(
	PF_PluginDataPtr inPtr,
	PF_PluginDataCB2 inPluginDataCallBackPtr,
	SPBasicSuite* inSPBasicSuitePtr,
	const char* inHostName,
	const char* inHostVersion)
{
	PF_Err result = PF_Err_INVALID_CALLBACK;

	result = PF_REGISTER_EFFECT_EXT2(
		inPtr,
		inPluginDataCallBackPtr,
		"stretch", // Name
		"Stretch", // Match Name
		"Stretch", // Category
		AE_RESERVED_INFO, // Reserved Info
		"EffectMain",	// Entry point
		"https://www.adobe.com");	// support URL

	return result;
}


PF_Err
EffectMain(
	PF_Cmd			cmd,
	PF_InData* in_data,
	PF_OutData* out_data,
	PF_ParamDef* params[],
	PF_LayerDef* output,
	void* extra)
{
	PF_Err		err = PF_Err_NONE;

	try {
		switch (cmd) {
		case PF_Cmd_ABOUT:
			err = About(in_data, out_data, params, output);
			break;
		case PF_Cmd_GLOBAL_SETUP:
			err = GlobalSetup(in_data, out_data, params, output);
			break;
		case PF_Cmd_PARAMS_SETUP:
			err = ParamsSetup(in_data, out_data, params, output);
			break;
		case PF_Cmd_RENDER:
			err = Render(in_data, out_data, params, output);
			break;
		}
	}
	catch (PF_Err& thrown_err) {
		err = thrown_err;
	}
	return err;
}


Date:20250108 8:35
Code:Skeleton.h
/*Skeleton.h*/
#pragma once

#ifndef SKELETON_H
#define SKELETON_H

typedef unsigned char u_char;
typedef unsigned short u_short;
typedef unsigned short u_int16;
typedef unsigned long u_long;
typedef short int int16;
#define PF_TABLE_BITS 12
#define PF_TABLE_SZ_16 4096

#define PF_DEEP_COLOR_AWARE 1

#include "AEConfig.h"

#ifdef AE_OS_WIN
typedef unsigned short PixelType;
#include <Windows.h>
#endif

#include "entry.h"
#include "AE_Effect.h"
#include "AE_EffectCB.h"
#include "AE_Macros.h"
#include "Param_Utils.h"
#include "AE_EffectCBSuites.h"
#include "String_Utils.h"
#include "AE_GeneralPlug.h"
#include "AEFX_ChannelDepthTpl.h"
#include "AEGP_SuiteHandler.h"

#include "Skeleton_Strings.h"

#include "AEFX_SuiteHelper.h"

#define MAJOR_VERSION 1
#define MINOR_VERSION 1
#define BUG_VERSION 0
#define STAGE_VERSION PF_Stage_DEVELOP
#define BUILD_VERSION 1

enum
{
	SKELETON_INPUT = 0,
	SKELETON_NUM_PARAMS = 1,
};
enum
{
	WIDTH_SLIDER_ID,
	LINE_X_SLIDER_ID,
	LINE_Y_SLIDER_ID,
	LINE_ANGRE_ID,
};
extern "C"
{

	DllExport
		PF_Err
		EffectMain(
			PF_Cmd cmd,
			PF_InData *in_data,
			PF_OutData *out_data,
			PF_ParamDef *params[],
			PF_LayerDef *output,
			void *extra);
}

#endif

Code:SkeletonPiPL.r
#include "AEConfig.h"
#include "AE_EffectVers.h"

#ifndef AE_OS_WIN
	#include <AE_General.r>
#endif
	
resource 'PiPL' (16000) {
	{	
		Kind {
			AEEffect
		},
		
		Name {
			"stretch"
		},
		
		Category {
			"Stretch"
		},
#ifdef AE_OS_WIN
	#ifdef AE_PROC_INTELx64
		CodeWin64X86 {"EffectMain"},
	#endif
#else
	#ifdef AE_OS_MAC
		CodeMacIntel64 {"EffectMain"},
		CodeMacARM64 {"EffectMain"},
	#endif
#endif
		
		AE_PiPL_Version {
			2,
			0
		},
		
		AE_Effect_Spec_Version {
			PF_PLUG_IN_VERSION,
			PF_PLUG_IN_SUBVERS
		},
		
		AE_Effect_Version {
			557057	/* 1.1 */
		},
		
		AE_Effect_Info_Flags {
			0
		},
		
		AE_Effect_Global_OutFlags {
			0x02000000 //50332160
		},
		
		AE_Effect_Global_OutFlags_2 {
			0x08000000 // PF_OutFlag2_SUPPORTS_THREADED_RENDERING
		},
		
		AE_Effect_Match_Name {
			"Stretch"
		},
		
		AE_Reserved_Info {
			0
		},
		
		AE_Effect_Support_URL {
			"https://www.adobe.com"
		}
	}
};

Code:Skeleton_Strings.cpp
#include "Skeleton.h"

typedef struct {
	A_u_long	index;
	A_char		str[256];
} TableString;

// 文字列テーブル
TableString		g_strs[StrID_NUMTYPES] = {
	StrID_NONE,						"",
	StrID_Name,						"stretch",
	StrID_Description,				"そんなの関係ある(ｷﾘｯ)"
};

char* GetStringPtr(int strNum)
{
	return g_strs[strNum].str;
}
Code:Skeleton.cpp
/*Skeleton.cpp*/
#include "Skeleton.h"

static PF_Err
About(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
	AEGP_SuiteHandler suites(in_data->pica_basicP);
	suites.ANSICallbacksSuite1()->sprintf(out_data->return_msg, "%s v%d.%d\r%s", STR(StrID_Name), MAJOR_VERSION, MINOR_VERSION, STR(StrID_Description));
	return PF_Err_NONE;
}

static PF_Err
GlobalSetup(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
	out_data->my_version = PF_VERSION(MAJOR_VERSION, MINOR_VERSION, BUG_VERSION, STAGE_VERSION, BUILD_VERSION);
	out_data->out_flags = PF_OutFlag_DEEP_COLOR_AWARE;				 // just 16bpc, not 32bpc
	out_data->out_flags2 |= PF_OutFlag2_SUPPORTS_THREADED_RENDERING; // MFR対応フラグを追加
	return PF_Err_NONE;
}

static PF_Err
FrameSetup(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
	return PF_Err_NONE;
}

static PF_Err ParamsSetup(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
	PF_Err err = PF_Err_NONE;
	PF_ParamDef def;

	AEFX_CLR_STRUCT(def);
	/*
	PF_ADD_FLOAT_SLIDERX(
		"width",     // パラメータ名
		0,                  // 最小値
		100,          // 最大値 (固定小数点形式)
		0,                  // 最小値 (UI表示用)
		100,                // 最大値 (UI表示用)
		0,           // デフォルト値 (固定小数点形式)
		PF_Precision_INTEGER,
		0,
		0,
		WIDTH_SLIDER_ID
	);
	*/
	out_data->num_params = SKELETON_NUM_PARAMS; // パラメーター数を設定
	return PF_Err_NONE;
}

#include <mutex>
std::mutex renderMutex;

static PF_Err Render(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
	PF_Err err = PF_Err_NONE;

	PF_EffectWorld* input = &params[0]->u.ld;
	PF_Pixel* input_pixels = (PF_Pixel*)input->data;
	PF_Pixel* output_pixels = (PF_Pixel*)output->data;

	int width = output->width;
	int height = output->height;
	int input_row_bytes = input->rowbytes / sizeof(PF_Pixel);
	int output_row_bytes = output->rowbytes / sizeof(PF_Pixel);

	for (int y = 0; y < height; y++) {
		for (int x = 0; x < width; x++) {
			PF_Pixel* input_pixel = input_pixels + y * input_row_bytes + x;
			PF_Pixel* output_pixel = output_pixels + y * output_row_bytes + x;

			output_pixel->red = 255 - input_pixel->red;
			output_pixel->green = 255 - input_pixel->green;
			output_pixel->blue = 255 - input_pixel->blue;
			output_pixel->alpha = input_pixel->alpha;
		}
	}

	return err;
}

extern "C" DllExport
	PF_Err
	PluginDataEntryFunction2(PF_PluginDataPtr inPtr, PF_PluginDataCB2 inPluginDataCallBackPtr, SPBasicSuite *inSPBasicSuitePtr, const char *inHostName, const char *inHostVersion)
{
	PF_Err result = PF_Err_INVALID_CALLBACK;

	result = PF_REGISTER_EFFECT_EXT2(
		inPtr,
		inPluginDataCallBackPtr,
		"stretch",				  // Name
		"Stretch",				  // Match Name
		"Stretch",				  // Category
		AE_RESERVED_INFO,		  // Reserved Info
		"EffectMain",			  // Entry point
		"https://www.adobe.com"); // support URL

	return result;
}

PF_Err
EffectMain(PF_Cmd cmd, PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output, void *extra)
{
	PF_Err err = PF_Err_NONE;
	try
	{
		switch (cmd)
		{
		case PF_Cmd_ABOUT:
			err = About(in_data, out_data, params, output);
			break;
		case PF_Cmd_GLOBAL_SETUP:
			err = GlobalSetup(in_data, out_data, params, output);
			break;
		case PF_Cmd_PARAMS_SETUP:
			err = ParamsSetup(in_data, out_data, params, output);
			break;
		case PF_Cmd_RENDER:
			err = Render(in_data, out_data, params, output);
			break;
		}
	}
	catch (PF_Err &thrown_err)
	{
		err = thrown_err;
	}
	return err;
}

Date:20250108 18:03
Code:Skeleton.h
/*Skeleton.h*/
#pragma once

#ifndef SKELETON_H
#define SKELETON_H

typedef unsigned char u_char;
typedef unsigned short u_short;
typedef unsigned short u_int16;
typedef unsigned long u_long;
typedef short int int16;
#define PF_TABLE_BITS 12
#define PF_TABLE_SZ_16 4096

#define PF_DEEP_COLOR_AWARE 1

#include "AEConfig.h"

#ifdef AE_OS_WIN
typedef unsigned short PixelType;
#include <Windows.h>
#endif

#include "entry.h"
#include "AE_Effect.h"
#include "AE_EffectCB.h"
#include "AE_Macros.h"
#include "Param_Utils.h"
#include "AE_EffectCBSuites.h"
#include "String_Utils.h"
#include "AE_GeneralPlug.h"
#include "AEFX_ChannelDepthTpl.h"
#include "AEGP_SuiteHandler.h"

#include "Skeleton_Strings.h"

#include "AEFX_SuiteHelper.h"

#define MAJOR_VERSION 1
#define MINOR_VERSION 1
#define BUG_VERSION 0
#define STAGE_VERSION PF_Stage_DEVELOP
#define BUILD_VERSION 1

enum
{
	SKELETON_INPUT = 0,
	SKELETON_NUM_PARAMS = 1,
};
enum
{
	WIDTH_SLIDER_ID,
	LINE_X_SLIDER_ID,
	LINE_Y_SLIDER_ID,
	LINE_ANGRE_ID,
};
extern "C"
{

	DllExport
		PF_Err
		EffectMain(
			PF_Cmd cmd,
			PF_InData *in_data,
			PF_OutData *out_data,
			PF_ParamDef *params[],
			PF_LayerDef *output,
			void *extra);
}

#endif

Code:SkeletonPiPL.r
#include "AEConfig.h"
#include "AE_EffectVers.h"

#ifndef AE_OS_WIN
	#include <AE_General.r>
#endif
	
resource 'PiPL' (16000) {
	{	
		Kind {
			AEEffect
		},
		
		Name {
			"stretch"
		},
		
		Category {
			"Stretch"
		},
#ifdef AE_OS_WIN
	#ifdef AE_PROC_INTELx64
		CodeWin64X86 {"EffectMain"},
	#endif
#else
	#ifdef AE_OS_MAC
		CodeMacIntel64 {"EffectMain"},
		CodeMacARM64 {"EffectMain"},
	#endif
#endif
		
		AE_PiPL_Version {
			2,
			0
		},
		
		AE_Effect_Spec_Version {
			PF_PLUG_IN_VERSION,
			PF_PLUG_IN_SUBVERS
		},
		
		AE_Effect_Version {
			557057	/* 1.1 */
		},
		
		AE_Effect_Info_Flags {
			0
		},
		
		AE_Effect_Global_OutFlags {
			0x02000000 //50332160
		},
		
		AE_Effect_Global_OutFlags_2 {
			0x08000000 // PF_OutFlag2_SUPPORTS_THREADED_RENDERING
		},
		
		AE_Effect_Match_Name {
			"Stretch"
		},
		
		AE_Reserved_Info {
			0
		},
		
		AE_Effect_Support_URL {
			"https://www.adobe.com"
		}
	}
};

Code:Skeleton_Strings.cpp
#include "Skeleton.h"

typedef struct {
	A_u_long	index;
	A_char		str[256];
} TableString;

// 文字列テーブル
TableString		g_strs[StrID_NUMTYPES] = {
	StrID_NONE,						"",
	StrID_Name,						"stretch",
	StrID_Description,				"そんなの関係ある(ｷﾘｯ)"
};

char* GetStringPtr(int strNum)
{
	return g_strs[strNum].str;
}

Code:Skeleton.cpp
/*Skeleton.cpp*/
#include "Skeleton.h"

static PF_Err
About(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
	AEGP_SuiteHandler suites(in_data->pica_basicP);
	suites.ANSICallbacksSuite1()->sprintf(out_data->return_msg, "%s v%d.%d\r%s", STR(StrID_Name), MAJOR_VERSION, MINOR_VERSION, STR(StrID_Description));
	return PF_Err_NONE;
}

static PF_Err
GlobalSetup(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
	out_data->my_version = PF_VERSION(MAJOR_VERSION, MINOR_VERSION, BUG_VERSION, STAGE_VERSION, BUILD_VERSION);
	out_data->out_flags = PF_OutFlag_DEEP_COLOR_AWARE;				 // just 16bpc, not 32bpc
	out_data->out_flags2 |= PF_OutFlag2_SUPPORTS_THREADED_RENDERING; // MFR対応フラグを追加
	return PF_Err_NONE;
}

static PF_Err
FrameSetup(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
	return PF_Err_NONE;
}

static PF_Err ParamsSetup(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
	PF_Err err = PF_Err_NONE;
	PF_ParamDef def;

	AEFX_CLR_STRUCT(def);
	/*
	PF_ADD_FLOAT_SLIDERX(
		"width",     // パラメータ名
		0,                  // 最小値
		100,          // 最大値 (固定小数点形式)
		0,                  // 最小値 (UI表示用)
		100,                // 最大値 (UI表示用)
		0,           // デフォルト値 (固定小数点形式)
		PF_Precision_INTEGER,
		0,
		0,
		WIDTH_SLIDER_ID
	);
	*/
	out_data->num_params = SKELETON_NUM_PARAMS; // パラメーター数を設定
	return PF_Err_NONE;
}

#include <mutex>
std::mutex renderMutex;

static PF_Err Render(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
	PF_Err err = PF_Err_NONE;

	PF_EffectWorld *input = &params[0]->u.ld;
	PF_Pixel *input_pixels = (PF_Pixel *)input->data;
	PF_Pixel *output_pixels = (PF_Pixel *)output->data;

	int width = output->width;
	int height = output->height;
	int input_row_bytes = input->rowbytes / sizeof(PF_Pixel);
	int output_row_bytes = output->rowbytes / sizeof(PF_Pixel);
	int shiftX = 50;
	int border = width / 2;

	for (int y = 0; y < height; y++)
	{
		for (int x = 0; x < width; x++)
		{
			PF_Pixel *input_pixel = input_pixels + y * input_row_bytes + x;
			PF_Pixel *output_pixel = output_pixels + y * output_row_bytes + x;

			if (x <= border + shiftX)
			{
				input_pixel += shiftX;
				output_pixel->red = input_pixel->red;
				output_pixel->green = input_pixel->green;
				output_pixel->blue = input_pixel->blue;
				output_pixel->alpha = input_pixel->alpha;
			}
			else if (border - shiftX < x && x < border + shiftX)
			{
				input_pixel += 0;
				output_pixel->red = input_pixel->red;
				output_pixel->green = input_pixel->green;
				output_pixel->blue = input_pixel->blue;
				output_pixel->alpha = input_pixel->alpha;
			}
			else
			{
				input_pixel += -1 * shiftX;
				output_pixel->red = input_pixel->red;
				output_pixel->green = input_pixel->green;
				output_pixel->blue = input_pixel->blue;
				output_pixel->alpha = input_pixel->alpha;
			}
		}
	}

	return err;
}

extern "C" DllExport
	PF_Err
	PluginDataEntryFunction2(PF_PluginDataPtr inPtr, PF_PluginDataCB2 inPluginDataCallBackPtr, SPBasicSuite *inSPBasicSuitePtr, const char *inHostName, const char *inHostVersion)
{
	PF_Err result = PF_Err_INVALID_CALLBACK;

	result = PF_REGISTER_EFFECT_EXT2(
		inPtr,
		inPluginDataCallBackPtr,
		"stretch",				  // Name
		"Stretch",				  // Match Name
		"Stretch",				  // Category
		AE_RESERVED_INFO,		  // Reserved Info
		"EffectMain",			  // Entry point
		"https://www.adobe.com"); // support URL

	return result;
}

PF_Err
EffectMain(PF_Cmd cmd, PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output, void *extra)
{
	PF_Err err = PF_Err_NONE;
	try
	{
		switch (cmd)
		{
		case PF_Cmd_ABOUT:
			err = About(in_data, out_data, params, output);
			break;
		case PF_Cmd_GLOBAL_SETUP:
			err = GlobalSetup(in_data, out_data, params, output);
			break;
		case PF_Cmd_PARAMS_SETUP:
			err = ParamsSetup(in_data, out_data, params, output);
			break;
		case PF_Cmd_RENDER:
			err = Render(in_data, out_data, params, output);
			break;
		}
	}
	catch (PF_Err &thrown_err)
	{
		err = thrown_err;
	}
	return err;
}

Date:20250108 19:48
Code:Skeleton.h
/*Skeleton.h*/
#pragma once

#ifndef SKELETON_H
#define SKELETON_H

typedef unsigned char u_char;
typedef unsigned short u_short;
typedef unsigned short u_int16;
typedef unsigned long u_long;
typedef short int int16;
#define PF_TABLE_BITS 12
#define PF_TABLE_SZ_16 4096

#define PF_DEEP_COLOR_AWARE 1

#include "AEConfig.h"

#ifdef AE_OS_WIN
typedef unsigned short PixelType;
#include <Windows.h>
#endif

#include "entry.h"
#include "AE_Effect.h"
#include "AE_EffectCB.h"
#include "AE_Macros.h"
#include "Param_Utils.h"
#include "AE_EffectCBSuites.h"
#include "String_Utils.h"
#include "AE_GeneralPlug.h"
#include "AEFX_ChannelDepthTpl.h"
#include "AEGP_SuiteHandler.h"

#include "Skeleton_Strings.h"

#include "AEFX_SuiteHelper.h"

#define MAJOR_VERSION 1
#define MINOR_VERSION 1
#define BUG_VERSION 0
#define STAGE_VERSION PF_Stage_DEVELOP
#define BUILD_VERSION 1

enum
{
	SKELETON_INPUT = 0,
	WIDTH_SLIDER_ID,
	//LINE_X_SLIDER_ID,
	//LINE_Y_SLIDER_ID,
	//LINE_ANGRE_ID,
	SKELETON_NUM_PARAMS // ← パラメータの総数は最後に記述
};

extern "C"
{

	DllExport
		PF_Err
		EffectMain(
			PF_Cmd cmd,
			PF_InData *in_data,
			PF_OutData *out_data,
			PF_ParamDef *params[],
			PF_LayerDef *output,
			void *extra);
}

#endif

Code:SkeletonPiPL.r
#include "AEConfig.h"
#include "AE_EffectVers.h"

#ifndef AE_OS_WIN
	#include <AE_General.r>
#endif
	
resource 'PiPL' (16000) {
	{	
		Kind {
			AEEffect
		},
		
		Name {
			"stretch"
		},
		
		Category {
			"Stretch"
		},
#ifdef AE_OS_WIN
	#ifdef AE_PROC_INTELx64
		CodeWin64X86 {"EffectMain"},
	#endif
#else
	#ifdef AE_OS_MAC
		CodeMacIntel64 {"EffectMain"},
		CodeMacARM64 {"EffectMain"},
	#endif
#endif
		
		AE_PiPL_Version {
			2,
			0
		},
		
		AE_Effect_Spec_Version {
			PF_PLUG_IN_VERSION,
			PF_PLUG_IN_SUBVERS
		},
		
		AE_Effect_Version {
			557057	/* 1.1 */
		},
		
		AE_Effect_Info_Flags {
			0
		},
		
		AE_Effect_Global_OutFlags {
			0x02000000 //50332160
		},
		
		AE_Effect_Global_OutFlags_2 {
			0x08000000 // PF_OutFlag2_SUPPORTS_THREADED_RENDERING
		},
		
		AE_Effect_Match_Name {
			"Stretch"
		},
		
		AE_Reserved_Info {
			0
		},
		
		AE_Effect_Support_URL {
			"https://www.adobe.com"
		}
	}
};

Code:Skeleton_Strings.cpp
#include "Skeleton.h"

typedef struct {
	A_u_long	index;
	A_char		str[256];
} TableString;

// 文字列テーブル
TableString		g_strs[StrID_NUMTYPES] = {
	StrID_NONE,						"",
	StrID_Name,						"stretch",
	StrID_Description,				"そんなの関係ある(ｷﾘｯ)"
};

char* GetStringPtr(int strNum)
{
	return g_strs[strNum].str;
}

Code:Skeleton.cpp
/*Skeleton.cpp*/
#include "Skeleton.h"

static PF_Err
About(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
	AEGP_SuiteHandler suites(in_data->pica_basicP);
	suites.ANSICallbacksSuite1()->sprintf(out_data->return_msg, "%s v%d.%d\r%s", STR(StrID_Name), MAJOR_VERSION, MINOR_VERSION, STR(StrID_Description));
	return PF_Err_NONE;
}

static PF_Err
GlobalSetup(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
	out_data->my_version = PF_VERSION(MAJOR_VERSION, MINOR_VERSION, BUG_VERSION, STAGE_VERSION, BUILD_VERSION);
	out_data->out_flags = PF_OutFlag_DEEP_COLOR_AWARE;				 // just 16bpc, not 32bpc
	out_data->out_flags2 |= PF_OutFlag2_SUPPORTS_THREADED_RENDERING; // MFR対応フラグを追加
	return PF_Err_NONE;
}

static PF_Err
FrameSetup(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
	return PF_Err_NONE;
}

static PF_Err ParamsSetup(PF_InData* in_data, PF_OutData* out_data, PF_ParamDef* params[], PF_LayerDef* output)
{
	PF_Err err = PF_Err_NONE;
	PF_ParamDef def;

	AEFX_CLR_STRUCT(def);

	PF_ADD_FLOAT_SLIDERX(
		"Shift Amount",    // パラメータ名
		0,                 // 最小値 (エンジン用)
		3000,               // 最大値 (エンジン用)
		0,                 // 最小値 (UI用)
		3000,               // 最大値 (UI用)
		0,                // デフォルト値
		PF_Precision_INTEGER, // 整数として扱う
		0,
		0,
		WIDTH_SLIDER_ID
	);

	out_data->num_params = SKELETON_NUM_PARAMS; // パラメータ数を設定
	return PF_Err_NONE;
}

#include <mutex>
std::mutex renderMutex;

static PF_Err Render(PF_InData* in_data, PF_OutData* out_data, PF_ParamDef* params[], PF_LayerDef* output)
{
	PF_Err err = PF_Err_NONE;

	PF_EffectWorld* input = &params[0]->u.ld;
	PF_Pixel* input_pixels = (PF_Pixel*)input->data;
	PF_Pixel* output_pixels = (PF_Pixel*)output->data;

	int width = output->width;
	int height = output->height;
	int input_row_bytes = input->rowbytes / sizeof(PF_Pixel);
	int output_row_bytes = output->rowbytes / sizeof(PF_Pixel);

	// スライダーの値を取得 (整数値としてキャスト)
	int shiftX = (int)(params[WIDTH_SLIDER_ID]->u.fs_d.value);

	// shiftX の値が不正範囲にないか確認
	if (shiftX < 0 || shiftX > width / 2) {
		shiftX = 0; // 安全な値にリセット
	}

	int border = width / 2;

	for (int y = 0; y < height; y++)
	{
		for (int x = 0; x < width; x++)
		{
			PF_Pixel* input_pixel = NULL;
			PF_Pixel* output_pixel = output_pixels + y * output_row_bytes + x;

			if (x < border - shiftX) // 左側: 左にシフト
			{
				if (x + shiftX < width)
				{
					input_pixel = input_pixels + y * input_row_bytes + (x + shiftX);
				}
			}
			else if (x > border + shiftX) // 右側: 右にシフト
			{
				if (x - shiftX >= 0)
				{
					input_pixel = input_pixels + y * input_row_bytes + (x - shiftX);
				}
			}
			else // 中央: 中心線で埋める
			{
				input_pixel = input_pixels + y * input_row_bytes + border;
			}

			// ピクセルのコピー (範囲チェック済み)
			if (input_pixel)
			{
				output_pixel->red = input_pixel->red;
				output_pixel->green = input_pixel->green;
				output_pixel->blue = input_pixel->blue;
				output_pixel->alpha = input_pixel->alpha;
			}
		}
	}

	return err;
}



extern "C" DllExport
	PF_Err
	PluginDataEntryFunction2(PF_PluginDataPtr inPtr, PF_PluginDataCB2 inPluginDataCallBackPtr, SPBasicSuite *inSPBasicSuitePtr, const char *inHostName, const char *inHostVersion)
{
	PF_Err result = PF_Err_INVALID_CALLBACK;

	result = PF_REGISTER_EFFECT_EXT2(
		inPtr,
		inPluginDataCallBackPtr,
		"stretch",				  // Name
		"Stretch",				  // Match Name
		"Stretch",				  // Category
		AE_RESERVED_INFO,		  // Reserved Info
		"EffectMain",			  // Entry point
		"https://www.adobe.com"); // support URL

	return result;
}

PF_Err
EffectMain(PF_Cmd cmd, PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output, void *extra)
{
	PF_Err err = PF_Err_NONE;
	try
	{
		switch (cmd)
		{
		case PF_Cmd_ABOUT:
			err = About(in_data, out_data, params, output);
			break;
		case PF_Cmd_GLOBAL_SETUP:
			err = GlobalSetup(in_data, out_data, params, output);
			break;
		case PF_Cmd_PARAMS_SETUP:
			err = ParamsSetup(in_data, out_data, params, output);
			break;
		case PF_Cmd_RENDER:
			err = Render(in_data, out_data, params, output);
			break;
		}
	}
	catch (PF_Err &thrown_err)
	{
		err = thrown_err;
	}
	return err;
}
Date:20250109 8:35
Code:Skeleton.h
/*Skeleton.h*/
#pragma once

#ifndef SKELETON_H
#define SKELETON_H

typedef unsigned char u_char;
typedef unsigned short u_short;
typedef unsigned short u_int16;
typedef unsigned long u_long;
typedef short int int16;
#define PF_TABLE_BITS 12
#define PF_TABLE_SZ_16 4096

#define PF_DEEP_COLOR_AWARE 1

#include "AEConfig.h"

#ifdef AE_OS_WIN
typedef unsigned short PixelType;
#include <Windows.h>
#endif

#include "entry.h"
#include "AE_Effect.h"
#include "AE_EffectCB.h"
#include "AE_Macros.h"
#include "Param_Utils.h"
#include "AE_EffectCBSuites.h"
#include "String_Utils.h"
#include "AE_GeneralPlug.h"
#include "AEFX_ChannelDepthTpl.h"
#include "AEGP_SuiteHandler.h"

#include "Skeleton_Strings.h"

#include "AEFX_SuiteHelper.h"

#define MAJOR_VERSION 1
#define MINOR_VERSION 1
#define BUG_VERSION 0
#define STAGE_VERSION PF_Stage_DEVELOP
#define BUILD_VERSION 1

enum
{
	SKELETON_INPUT = 0,
	WIDTH_SLIDER_ID,
	//LINE_X_SLIDER_ID,
	//LINE_Y_SLIDER_ID,
	//LINE_ANGRE_ID,
	SKELETON_NUM_PARAMS // ← パラメータの総数は最後に記述
};

extern "C"
{

	DllExport
		PF_Err
		EffectMain(
			PF_Cmd cmd,
			PF_InData *in_data,
			PF_OutData *out_data,
			PF_ParamDef *params[],
			PF_LayerDef *output,
			void *extra);
}

#endif

Code:SkeletonPiPL.r
#include "AEConfig.h"
#include "AE_EffectVers.h"

#ifndef AE_OS_WIN
	#include <AE_General.r>
#endif
	
resource 'PiPL' (16000) {
	{	
		Kind {
			AEEffect
		},
		
		Name {
			"stretch"
		},
		
		Category {
			"Stretch"
		},
#ifdef AE_OS_WIN
	#ifdef AE_PROC_INTELx64
		CodeWin64X86 {"EffectMain"},
	#endif
#else
	#ifdef AE_OS_MAC
		CodeMacIntel64 {"EffectMain"},
		CodeMacARM64 {"EffectMain"},
	#endif
#endif
		
		AE_PiPL_Version {
			2,
			0
		},
		
		AE_Effect_Spec_Version {
			PF_PLUG_IN_VERSION,
			PF_PLUG_IN_SUBVERS
		},
		
		AE_Effect_Version {
			557057	/* 1.1 */
		},
		
		AE_Effect_Info_Flags {
			0
		},
		
		AE_Effect_Global_OutFlags {
			0x02000000 //50332160
		},
		
		AE_Effect_Global_OutFlags_2 {
			0x08000000 // PF_OutFlag2_SUPPORTS_THREADED_RENDERING
		},
		
		AE_Effect_Match_Name {
			"Stretch"
		},
		
		AE_Reserved_Info {
			0
		},
		
		AE_Effect_Support_URL {
			"https://www.adobe.com"
		}
	}
};

Code:Skeleton_Strings.cpp
#include "Skeleton.h"

typedef struct {
	A_u_long	index;
	A_char		str[256];
} TableString;

// 文字列テーブル
TableString		g_strs[StrID_NUMTYPES] = {
	StrID_NONE,						"",
	StrID_Name,						"stretch",
	StrID_Description,				"そんなの関係ある(ｷﾘｯ)"
};

char* GetStringPtr(int strNum)
{
	return g_strs[strNum].str;
}

Code:Skeleton.cpp
/*Skeleton.cpp*/
#include "Skeleton.h"

static PF_Err
About(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
    AEGP_SuiteHandler suites(in_data->pica_basicP);
    suites.ANSICallbacksSuite1()->sprintf(out_data->return_msg, "%s v%d.%d\r%s", STR(StrID_Name), MAJOR_VERSION, MINOR_VERSION, STR(StrID_Description));
    return PF_Err_NONE;
}

static PF_Err
GlobalSetup(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
    out_data->my_version = PF_VERSION(MAJOR_VERSION, MINOR_VERSION, BUG_VERSION, STAGE_VERSION, BUILD_VERSION);
    out_data->out_flags = PF_OutFlag_DEEP_COLOR_AWARE;               // just 16bpc, not 32bpc
    out_data->out_flags2 |= PF_OutFlag2_SUPPORTS_THREADED_RENDERING; // MFR対応フラグを追加
    return PF_Err_NONE;
}

static PF_Err
FrameSetup(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
    return PF_Err_NONE;
}

static PF_Err ParamsSetup(PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output)
{
    PF_Err err = PF_Err_NONE;
    PF_ParamDef def;

    AEFX_CLR_STRUCT(def);

    PF_ADD_FLOAT_SLIDERX(
        "Shift Amount",       // パラメータ名
        0,                    // 最小値 (エンジン用)
        3000,                 // 最大値 (エンジン用)
        0,                    // 最小値 (UI用)
        500,                  // 最大値 (UI用)
        0,                    // デフォルト値
        PF_Precision_INTEGER, // 整数として扱う
        0,
        0,
        WIDTH_SLIDER_ID);
    PF_ADD_POPUP(
        "Direction",             // パラメーター名
        3,                       // オプション数
        1,                       // デフォルト選択 (1: 両方向)
        "Both|Forward|Backward", // オプションの表示テキスト (|で区切る)
        SELECTBOX_ID             // 識別子
    );
    PF_ADD_FLOAT_SLIDERX(
        "Border Position",    // パラメータ名
        -3000,                // 最小値 (エンジン用)
        3000,                 // 最大値 (エンジン用)
        -500,                 // 最小値 (UI用)
        500,                  // 最大値 (UI用)
        0,                    // デフォルト値
        PF_Precision_INTEGER, // 整数として扱う
        0,
        0,
        POSITION_SLIDER_ID);
    out_data->num_params = SKELETON_NUM_PARAMS; // パラメータ数を設定
    return PF_Err_NONE;
}

#include <mutex>
std::mutex renderMutex;
#include <algorithm> // std::clamp を使用

static PF_Err Render(PF_InData* in_data, PF_OutData* out_data, PF_ParamDef* params[], PF_LayerDef* output)
{
    PF_Err err = PF_Err_NONE;

    PF_EffectWorld* input = &params[0]->u.ld;
    PF_Pixel* input_pixels = (PF_Pixel*)input->data;
    PF_Pixel* output_pixels = (PF_Pixel*)output->data;

    int width = output->width;
    int height = output->height;
    int input_row_bytes = input->rowbytes / sizeof(PF_Pixel);
    int output_row_bytes = output->rowbytes / sizeof(PF_Pixel);

    // ダウンサンプリングを考慮したシフト量
    int shiftX = (int)(params[WIDTH_SLIDER_ID]->u.fs_d.value);
    shiftX = (int)(shiftX * ((float)in_data->downsample_x.den / (float)in_data->downsample_x.num));

    int border = width / 2 + (int)(params[POSITION_SLIDER_ID]->u.fs_d.value); // 中心線
    border = std::clamp(border, 0, width);

    // 方向パラメーターの取得
    int direction = params[SELECTBOX_ID]->u.pd.value;

    // シフト量が0の場合は、画像をそのまま保持
    if (shiftX == 0) {
        for (int y = 0; y < height; y++) {
            for (int x = 0; x < width; x++) {
                PF_Pixel* input_pixel = input_pixels + y * input_row_bytes + x;
                PF_Pixel* output_pixel = output_pixels + y * output_row_bytes + x;

                output_pixel->red = input_pixel->red;
                output_pixel->green = input_pixel->green;
                output_pixel->blue = input_pixel->blue;
                output_pixel->alpha = input_pixel->alpha;
            }
        }
    }
    else {
        // 既存のシフト処理
        for (int y = 0; y < height; y++) {
            for (int x = 0; x < width; x++) {
                PF_Pixel* input_pixel = NULL;
                PF_Pixel* output_pixel = output_pixels + y * output_row_bytes + x;

                switch (direction)
                {
                case 1:                      // 両方向 (Both)
                    if (x < border - shiftX) // 左側: 左にシフト
                    {
                        int shifted_x = x + shiftX/2;
                        if (shifted_x < width)
                        {
                            input_pixel = input_pixels + y * input_row_bytes + shifted_x;
                        }
                        else
                        {
                            input_pixel = input_pixels + y * input_row_bytes + border; // ボーダーピクセル
                        }
                    }
                    else if (x > border + shiftX) // 右側: 右にシフト
                    {
                        int shifted_x = x - shiftX/2;
                        if (shifted_x >= 0)
                        {
                            input_pixel = input_pixels + y * input_row_bytes + shifted_x;
                        }
                        else
                        {
                            input_pixel = input_pixels + y * input_row_bytes + border; // ボーダーピクセル
                        }
                    }
                    else // 中央: ボーダーのピクセルで埋める
                    {
                        input_pixel = input_pixels + y * input_row_bytes + border;
                    }
                    break;

                case 2:              // 正方向 (Forward)
                    if (x >= border) // ボーダーより右の部分だけシフト
                    {
                        int shifted_x = x - shiftX;
                        if (shifted_x - border >= 0)
                        {
                            input_pixel = input_pixels + y * input_row_bytes + shifted_x;
                        }
                        else // シフト範囲外はボーダーで埋める
                        {
                            input_pixel = input_pixels + y * input_row_bytes + border;
                        }
                    }
                    else // ボーダー左側は元のピクセルを保持
                    {
                        input_pixel = input_pixels + y * input_row_bytes + x;
                    }
                    break;

                case 3:             // 逆方向 (Backward)
                    if (x < border) // ボーダーより左の部分だけシフト
                    {
                        int shifted_x = x + shiftX;
                        if (shifted_x < border)
                        {
                            input_pixel = input_pixels + y * input_row_bytes + shifted_x;
                        }
                        else // シフト範囲外はボーダーで埋める
                        {
                            input_pixel = input_pixels + y * input_row_bytes + border;
                        }
                    }
                    else // ボーダー右側は元のピクセルを保持
                    {
                        input_pixel = input_pixels + y * input_row_bytes + x;
                    }
                    break;

                default:
                    break;
                }

                // ピクセルのコピー
                if (input_pixel)
                {
                    output_pixel->red = input_pixel->red;
                    output_pixel->green = input_pixel->green;
                    output_pixel->blue = input_pixel->blue;
                    output_pixel->alpha = input_pixel->alpha;
                }
            }
        }
    }

    return err;
}


extern "C" DllExport
    PF_Err
    PluginDataEntryFunction2(PF_PluginDataPtr inPtr, PF_PluginDataCB2 inPluginDataCallBackPtr, SPBasicSuite *inSPBasicSuitePtr, const char *inHostName, const char *inHostVersion)
{
    PF_Err result = PF_Err_INVALID_CALLBACK;

    result = PF_REGISTER_EFFECT_EXT2(
        inPtr,
        inPluginDataCallBackPtr,
        "stretch",                // Name
        "Stretch",                // Match Name
        "Stretch",                // Category
        AE_RESERVED_INFO,         // Reserved Info
        "EffectMain",             // Entry point
        "https://www.adobe.com"); // support URL

    return result;
}

PF_Err
EffectMain(PF_Cmd cmd, PF_InData *in_data, PF_OutData *out_data, PF_ParamDef *params[], PF_LayerDef *output, void *extra)
{
    PF_Err err = PF_Err_NONE;
    try
    {
        switch (cmd)
        {
        case PF_Cmd_ABOUT:
            err = About(in_data, out_data, params, output);
            break;
        case PF_Cmd_GLOBAL_SETUP:
            err = GlobalSetup(in_data, out_data, params, output);
            break;
        case PF_Cmd_PARAMS_SETUP:
            err = ParamsSetup(in_data, out_data, params, output);
            break;
        case PF_Cmd_RENDER:
            err = Render(in_data, out_data, params, output);
            break;
        }
    }
    catch (PF_Err &thrown_err)
    {
        err = thrown_err;
    }
    return err;
}

Date:YYYYMMDD WW:MM
Code:Skeleton.h
Code:SkeletonPiPL.r
Code:Skeleton_Strings.cpp
Code:Skeleton.cpp

Date:YYYYMMDD WW:MM
Code:Skeleton.h
Code:SkeletonPiPL.r
Code:Skeleton_Strings.cpp
Code:Skeleton.cpp